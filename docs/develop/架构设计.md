# 系统架构设计

## 概述

数据中间件采用分层架构设计，使用Go语言实现，支持高并发访问、多种数据源切换、多游戏业务逻辑扩展。

## 整体架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                    协议适配层 (Protocol Layer)                │
│  ┌─────────────────┬─────────────────┬─────────────────┐     │
│  │   TCP Server    │   HTTP Server   │   WebSocket     │     │
│  │ (游戏服务器)     │ (网站服务)       │ (实时推送)       │     │
│  └─────────────────┴─────────────────┴─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business Layer)                 │
│  ┌─────────────────┬─────────────────┬─────────────────┐     │
│  │  Game Router    │ Business Logic  │  Data Router    │     │
│  │ (游戏路由选择)   │ (业务处理)       │ (数据路由)       │     │
│  └─────────────────┴─────────────────┴─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                  数据访问层 (Data Access Layer)              │
│  ┌─────────────────┬─────────────────┬─────────────────┐     │
│  │   DAO Layer     │   ORM Layer     │ Connection Pool │     │
│  │ (数据访问对象)   │ (对象关系映射)   │ (连接池管理)     │     │
│  └─────────────────┴─────────────────┴─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
                                 │
┌─────────────────────────────────────────────────────────────┐
│                  基础设施层 (Infrastructure Layer)           │
│  ┌─────────────────┬─────────────────┬─────────────────┐     │
│  │ Authentication  │   Caching       │   Logging       │     │
│  │ (鉴权认证)       │ (缓存服务)       │ (日志服务)       │     │
│  └─────────────────┴─────────────────┴─────────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

## 分层详细设计

### 1. 协议适配层 (Protocol Layer)

#### 1.1 TCP服务器模块
- **功能**: 处理游戏服务器的自定义TCP协议请求
- **技术栈**: Go net包 + 自定义协议解析
- **核心组件**:
  - TCP连接监听器
  - 协议解析器 (Protocol Parser)
  - 请求分发器 (Request Dispatcher)

#### 1.2 HTTP服务器模块
- **功能**: 为网站前端和管理后台提供RESTful API
- **技术栈**: Gin框架
- **核心组件**:
  - RESTful API路由
  - JSON序列化/反序列化
  - CORS跨域处理
  - 请求限流中间件

#### 1.3 WebSocket模块 (可选扩展)
- **功能**: 实时数据推送服务
- **技术栈**: Gorilla WebSocket

### 2. 业务逻辑层 (Business Layer)

#### 2.1 游戏路由器 (Game Router)
- **功能**: 根据请求识别目标游戏，进行路由分发
- **实现方式**: 工厂模式 + 策略模式
- **配置方式**: 配置文件指定游戏ID到处理器映射

#### 2.2 业务逻辑处理器 (Business Logic Handler)
- **功能**: 处理具体业务逻辑
- **设计模式**: 插件化架构，每个游戏一个业务逻辑包
- **核心接口**:
  ```go
  type GameHandler interface {
      HandlePlayer(ctx context.Context, req *PlayerRequest) (*PlayerResponse, error)
      HandleItem(ctx context.Context, req *ItemRequest) (*ItemResponse, error)
      // ... 其他业务接口
  }
  ```

#### 2.3 数据路由器 (Data Router)
- **功能**: 根据游戏ID路由到对应的数据库
- **实现**: 数据库连接池管理器 + 分片策略

### 3. 数据访问层 (Data Access Layer)

#### 3.1 DAO层 (Data Access Object)
- **功能**: 数据访问对象，封装CRUD操作
- **设计原则**: 每个业务实体对应一个DAO
- **接口定义**:
  ```go
  type PlayerDAO interface {
      Insert(ctx context.Context, player *Player) error
      Update(ctx context.Context, player *Player) error
      Delete(ctx context.Context, playerID int64) error
      SelectByID(ctx context.Context, playerID int64) (*Player, error)
      SelectByCondition(ctx context.Context, condition map[string]interface{}) ([]*Player, error)
  }
  ```

#### 3.2 ORM层 (Object-Relational Mapping)
- **功能**: 对象关系映射，支持Oracle/MySQL切换
- **技术选择**: GORM (支持多种数据库)
- **切换策略**: 通过配置文件动态切换数据库驱动

#### 3.3 连接池管理 (Connection Pool Manager)
- **功能**: 数据库连接池管理，支持多数据源
- **特性**:
  - 连接池大小配置
  - 健康检查
  - 故障转移

### 4. 基础设施层 (Infrastructure Layer)

#### 4.1 鉴权认证模块 (Authentication)
- **功能**: 统一的身份认证和权限控制
- **认证方式**:
  - Token认证 (JWT)
  - API密钥认证
  - 游戏服务器专用认证
- **权限控制**: 基于角色的访问控制 (RBAC)

#### 4.2 缓存服务 (Caching)
- **功能**: 数据缓存，提升性能
- **技术选择**: Redis
- **缓存策略**:
  - 热点数据缓存
  - 查询结果缓存
  - 会话缓存

#### 4.3 日志服务 (Logging)
- **功能**: 统一的日志记录
- **日志级别**: DEBUG, INFO, WARN, ERROR
- **日志内容**:
  - 请求日志 (访问时间、来源、操作类型)
  - 错误日志 (异常信息、堆栈跟踪)
  - 性能日志 (响应时间、资源使用)
  - 审计日志 (敏感操作记录)

## 配置管理设计

### 配置文件结构
```yaml
# 主配置文件
server:
  tcp:
    address: ":8080"
    max_connections: 10000
  http:
    address: ":8081"
    read_timeout: 30s
    write_timeout: 30s

database:
  default: oracle  # 当前默认数据库类型
  connections:
    game1:
      type: oracle
      host: "oracle-host"
      port: 1521
      username: "user"
      password: "pass"
      database: "game1"
      max_open_conns: 100
      max_idle_conns: 10
    game2:
      type: mysql
      host: "mysql-host"
      port: 3306
      username: "user"
      password: "pass"
      database: "game2"
      max_open_conns: 100
      max_idle_conns: 10

games:
  game1:
    id: "game1"
    name: "游戏1"
    database: "game1"
    enabled: true
  game2:
    id: "game2"
    name: "游戏2"
    database: "game2"
    enabled: false

auth:
  jwt_secret: "your-secret-key"
  token_expire: 24h
  api_keys:
    - key: "game-server-key"
      permissions: ["read", "write"]

logging:
  level: "info"
  format: "json"
  outputs:
    - file: "/var/log/datamiddleware.log"
    - console: true
```

### 配置热更新
- 支持配置文件的热重载
- 不中断服务的情况下更新数据库连接
- 动态启用/禁用游戏支持
- **高并发配置优化**: 运行时动态调整协程池大小、连接池参数

## 错误处理设计

### 错误码体系
- **系统级错误**: 1000-1999 (网络、数据库等)
- **业务级错误**: 2000-2999 (业务逻辑错误)
- **认证授权错误**: 3000-3999 (权限、认证失败)

### 统一错误响应
```go
type ErrorResponse struct {
    Code    int    `json:"code"`
    Message string `json:"message"`
    Details string `json:"details,omitempty"`
}
```

## 监控和运维

### 性能监控
- 请求响应时间统计
- 数据库连接池状态
- 内存使用情况
- Goroutine数量监控

### 健康检查
- 数据库连接检查
- 依赖服务状态检查
- 自定义业务健康指标

### 指标收集
- Prometheus集成
- 自定义业务指标
- 性能 profiling

## 项目目录结构

```
data-middleware/
├── cmd/                    # 应用入口
│   └── server/
│       └── main.go
├── internal/               # 内部包
│   ├── api/               # API层
│   │   ├── handlers/      # HTTP处理器
│   │   ├── middleware/    # 中间件
│   │   └── routes/        # 路由配置
│   ├── protocol/          # 协议层
│   │   ├── tcp/          # TCP协议实现
│   │   └── http/         # HTTP协议实现
│   ├── business/          # 业务逻辑层
│   │   ├── games/        # 游戏业务逻辑
│   │   │   ├── game1/    # 游戏1业务实现
│   │   │   └── game2/    # 游戏2业务实现
│   │   └── common/       # 通用业务逻辑
│   ├── data/             # 数据访问层
│   │   ├── dao/          # 数据访问对象
│   │   ├── models/       # 数据模型
│   │   └── migration/    # 数据库迁移
│   ├── infrastructure/   # 基础设施层
│   │   ├── auth/         # 认证授权
│   │   ├── cache/        # 缓存服务
│   │   ├── config/       # 配置管理
│   │   ├── logging/      # 日志服务
│   │   ├── pool/         # 对象池管理
│   │   ├── async/        # 异步处理
│   │   ├── monitor/      # 性能监控
│   │   └── metrics/      # 指标收集
│   └── common/           # 公共组件
│       ├── errors/       # 错误处理
│       ├── types/        # 通用类型
│       ├── utils/        # 工具函数
│       ├── concurrent/   # 并发工具
│       ├── buffer/       # 缓冲区管理
│       └── zerocopy/     # 零拷贝工具
├── pkg/                   # 公共包
│   ├── database/         # 数据库驱动封装
│   ├── protocol/         # 协议解析库
│   ├── pool/            # 高并发对象池
│   │   ├── buffer/      # 缓冲区对象池
│   │   ├── worker/      # 协程池管理
│   │   └── connection/  # 连接池管理
│   ├── async/           # 异步处理组件
│   │   ├── queue/       # 异步队列
│   │   └── task/        # 任务调度器
│   └── cache/           # 缓存组件
│       ├── local/       # 本地缓存
│       └── distributed/ # 分布式缓存
├── configs/              # 配置文件
│   ├── config.yaml       # 主配置文件
│   └── config.dev.yaml   # 开发环境配置
├── scripts/              # 脚本文件
│   ├── build.sh          # 构建脚本
│   ├── deploy.sh         # 部署脚本
│   └── init.sql          # 数据库初始化
├── docs/                 # 文档
│   ├── api.md            # API文档
│   ├── deploy.md         # 部署文档
│   └── design.md         # 设计文档
├── test/                 # 测试文件
│   ├── unit/            # 单元测试
│   ├── integration/     # 集成测试
│   └── e2e/             # 端到端测试
├── go.mod               # Go模块文件
├── go.sum               # Go依赖校验
├── Dockerfile           # Docker构建文件
├── docker-compose.yml   # Docker编排文件
└── README.md            # 项目说明
```

## 关键技术选型

### 核心框架
- **Web框架**: Gin (高性能HTTP框架) + fasthttp (极高性能可选)
- **ORM**: GORM (支持多数据库) + 自定义DAO优化
- **配置管理**: Viper (支持多种配置格式)
- **日志**: Zap (高性能结构化日志) + 异步日志

### 数据库
- **Oracle**: godror (Oracle驱动) + 连接池优化
- **MySQL**: go-sql-driver/mysql + 连接池优化
- **连接池**: database/sql + 自定义连接池管理

### 缓存
- **Redis**: go-redis/redis + 集群支持
- **本地缓存**: bigcache/freecache (高性能本地缓存)

### 协议
- **TCP**: 自定义协议 + protobuf/msgpack (高效序列化)
- **HTTP**: RESTful API + HTTP/2 + WebSocket

### 高并发专用组件
- **对象池**: sync.Pool + 自定义对象池
- **协程池**: ants (高性能协程池)
- **连接池**: 自定义TCP/HTTP连接池
- **Ring Buffer**: 环形缓冲区优化
