# 数据中间件部署文档

## 概述

本文档介绍数据中间件的部署方式，包括单机部署、Docker部署和集群部署。

## 系统要求

### 最低配置
- **CPU**: 2核
- **内存**: 4GB
- **磁盘**: 20GB
- **网络**: 100Mbps
- **操作系统**: Linux (Ubuntu 18.04+ / CentOS 7+)

### 推荐配置
- **CPU**: 8核
- **内存**: 16GB
- **磁盘**: 100GB SSD
- **网络**: 1Gbps
- **操作系统**: Ubuntu 20.04 LTS

### 高并发配置
- **CPU**: 16核+
- **内存**: 32GB+
- **磁盘**: 200GB+ SSD
- **网络**: 10Gbps
- **操作系统**: Ubuntu 22.04 LTS

## 依赖服务

### MySQL/MariaDB
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# 配置数据库
sudo mysql_secure_installation
mysql -u root -p
```

```sql
-- 创建数据库和用户
CREATE DATABASE datamiddleware DEFAULT CHARACTER SET utf8mb4;
CREATE USER 'datamiddleware'@'localhost' IDENTIFIED BY 'YourStrongPassword123!';
GRANT ALL PRIVILEGES ON datamiddleware.* TO 'datamiddleware'@'localhost';
FLUSH PRIVILEGES;
```

### Redis
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install redis-server

# 配置Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

## 单机部署

### 源码部署

#### 1. 下载源码
```bash
git clone https://github.com/your-org/datamiddleware.git
cd datamiddleware
```

#### 2. 安装Go
```bash
# Ubuntu/Debian
wget https://golang.org/dl/go1.21.5.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
export PATH=$PATH:/usr/local/go/bin
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
```

#### 3. 构建项目
```bash
# 使用构建脚本
./scripts/build.sh

# 或手动构建
go mod download
go build -o datamiddleware ./cmd/server
```

#### 4. 配置数据库
```bash
mysql -u root -p < scripts/init.sql
```

#### 5. 配置应用
```bash
# 编辑配置文件
vim configs/config.yaml

# 主要配置项
server:
  env: prod
  http:
    host: "0.0.0.0"
    port: 8080
  tcp:
    host: "0.0.0.0"
    port: 9090

database:
  driver: mysql
  host: "localhost"
  port: 3306
  username: "datamiddleware"
  password: "YourStrongPassword123!"
  database: "datamiddleware"

redis:
  host: "localhost"
  port: 6379
  password: ""
```

#### 6. 启动服务
```bash
# 前台运行
./datamiddleware

# 后台运行
nohup ./datamiddleware > logs/datamiddleware.log 2>&1 &
```

### Docker部署

#### 1. 构建镜像
```bash
# 使用Dockerfile构建
docker build -t datamiddleware:latest .

# 或使用构建脚本
./scripts/build.sh --docker
```

#### 2. 运行容器
```bash
# 创建网络
docker network create datamiddleware-net

# 启动MySQL
docker run -d \
  --name datamiddleware-mysql \
  --network datamiddleware-net \
  -e MYSQL_ROOT_PASSWORD=YourStrongPassword123! \
  -e MYSQL_DATABASE=datamiddleware \
  -e MYSQL_USER=datamiddleware \
  -e MYSQL_PASSWORD=YourStrongPassword123! \
  -p 3306:3306 \
  mysql:8.0

# 启动Redis
docker run -d \
  --name datamiddleware-redis \
  --network datamiddleware-net \
  -p 6379:6379 \
  redis:7-alpine

# 启动应用
docker run -d \
  --name datamiddleware \
  --network datamiddleware-net \
  -p 8080:8080 \
  -p 9090:9090 \
  -v $(pwd)/configs:/app/configs \
  -v $(pwd)/logs:/app/logs \
  datamiddleware:latest
```

## Docker Compose部署

### 单机部署
```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: YourStrongPassword123!
      MYSQL_DATABASE: datamiddleware
      MYSQL_USER: datamiddleware
      MYSQL_PASSWORD: YourStrongPassword123!
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  datamiddleware:
    build: .
    ports:
      - "8080:8080"
      - "9090:9090"
    volumes:
      - ./configs:/app/configs
      - ./logs:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - CONFIG_FILE=configs/config.yaml
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
```

### 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f datamiddleware
```

## 集群部署

### 负载均衡器配置

#### Nginx配置
```nginx
# nginx.conf
upstream datamiddleware_backend {
    ip_hash;  # TCP连接需要会话粘性
    server 192.168.1.101:8080 weight=1;
    server 192.168.1.102:8080 weight=1;
    server 192.168.1.103:8080 weight=1;
}

upstream datamiddleware_tcp {
    ip_hash;
    server 192.168.1.101:9090;
    server 192.168.1.102:9090;
    server 192.168.1.103:9090;
}

server {
    listen 80;
    server_name api.yourdomain.com;

    # HTTP API
    location / {
        proxy_pass http://datamiddleware_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 健康检查
    location /health {
        proxy_pass http://datamiddleware_backend;
        access_log off;
    }
}

# TCP负载均衡 (需要stream模块)
stream {
    upstream datamiddleware_games {
        hash $remote_addr consistent;
        server 192.168.1.101:9090;
        server 192.168.1.102:9090;
        server 192.168.1.103:9090;
    }

    server {
        listen 9090;
        proxy_pass datamiddleware_games;
        proxy_timeout 30s;
    }
}
```

### 数据库集群配置

#### 主从复制
```sql
-- 主库配置 (my.cnf)
[mysqld]
server-id=1
log-bin=mysql-bin
binlog-do-db=datamiddleware

-- 从库配置
CHANGE MASTER TO
    MASTER_HOST='master-host',
    MASTER_USER='replica',
    MASTER_PASSWORD='replica-password',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=0;
START SLAVE;
```

### Redis集群配置

#### Redis Cluster
```bash
# 创建集群
redis-cli --cluster create \
  192.168.1.101:6379 \
  192.168.1.102:6380 \
  192.168.1.103:6381 \
  --cluster-replicas 1
```

## 监控和日志

### 日志配置
```yaml
# configs/config.yaml
logging:
  level: info
  format: json
  output: both
  file:
    path: "/var/log/datamiddleware/app.log"
    max_size: 100
    max_backups: 10
    max_age: 30
    compress: true
```

### 监控指标
- **应用指标**: `/metrics` 接口
- **健康检查**: `/health` 接口
- **系统监控**: CPU、内存、磁盘使用率
- **业务监控**: 请求数、响应时间、错误率

## 备份策略

### 数据库备份
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u datamiddleware -p datamiddleware > backup_$DATE.sql
gzip backup_$DATE.sql
```

### 配置备份
```bash
# 配置备份
tar -czf configs_backup_$(date +%Y%m%d).tar.gz configs/
```

### 自动备份
```bash
# 添加到crontab
0 2 * * * /path/to/backup.sh  # 每日凌晨2点备份
```

## 升级部署

### 滚动升级
```bash
# 逐个更新容器
docker-compose up -d datamiddleware --scale datamiddleware=3

# 等待健康检查通过
sleep 30

# 停止旧容器
docker-compose up -d datamiddleware --scale datamiddleware=2
docker-compose up -d datamiddleware --scale datamiddleware=1
```

### 蓝绿部署
```bash
# 创建新版本
docker tag datamiddleware:v1 datamiddleware:v2

# 启动新版本
docker-compose -f docker-compose.v2.yml up -d

# 切换流量
# 更新nginx upstream配置

# 停止旧版本
docker-compose down
```

## 故障排除

### 常见问题

#### 1. 数据库连接失败
```bash
# 检查MySQL状态
sudo systemctl status mysql
sudo netstat -tlnp | grep 3306

# 检查连接配置
mysql -h localhost -P 3306 -u datamiddleware -p datamiddleware
```

#### 2. Redis连接失败
```bash
# 检查Redis状态
redis-cli ping
redis-cli info

# 检查配置
telnet localhost 6379
```

#### 3. 应用启动失败
```bash
# 查看应用日志
tail -f logs/datamiddleware.log

# 检查端口占用
netstat -tlnp | grep :8080
netstat -tlnp | grep :9090

# 检查配置文件
./datamiddleware --config configs/config.yaml --validate
```

#### 4. 性能问题
```bash
# 查看系统资源
top -p $(pgrep datamiddleware)
free -h
iostat -x 1

# 查看应用指标
curl http://localhost:8080/metrics
```

### 日志分析
```bash
# 错误日志统计
grep "ERROR" logs/datamiddleware.log | tail -20

# 性能日志分析
grep "response_time" logs/datamiddleware.log | awk '{print $NF}' | sort -n | tail -10
```

## 安全配置

### 防火墙配置
```bash
# 只开放必要端口
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8080/tcp
sudo ufw allow 9090/tcp
sudo ufw --force enable
```

### SSL/TLS配置
```nginx
# nginx HTTPS配置
server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://datamiddleware_backend;
        proxy_set_header X-Forwarded-Proto https;
    }
}
```

### 安全加固
- 定期更新系统和依赖
- 使用强密码和密钥轮换
- 启用审计日志
- 配置资源限制
- 定期安全扫描

## 性能调优

### 内核参数优化
```bash
# /etc/sysctl.conf
net.core.somaxconn = 655350
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.ip_local_port_range = 1024 65535
fs.file-max = 2097152
```

### 应用配置调优
```yaml
# 高并发配置
server:
  tcp:
    max_connections: 50000
  http:
    max_concurrent: 10000

database:
  max_open_conns: 500
  max_idle_conns: 100

cache:
  pool_size: 100
```

### 监控告警
- CPU使用率 > 80% 告警
- 内存使用率 > 85% 告警
- 磁盘空间 < 10% 告警
- 错误率 > 1% 告警
- 响应时间 > 500ms 告警
