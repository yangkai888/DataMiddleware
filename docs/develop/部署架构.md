# éƒ¨ç½²æ¶æ„æŒ‡å—

## æ¦‚è¿°

æ•°æ®ä¸­é—´ä»¶æ”¯æŒå•æœºéƒ¨ç½²ã€Dockerå®¹å™¨éƒ¨ç½²å’ŒKubernetesé›†ç¾¤éƒ¨ç½²ï¼Œæ»¡è¶³ä¸åŒè§„æ¨¡çš„åº”ç”¨åœºæ™¯ã€‚

## å•æœºéƒ¨ç½²

### ç¯å¢ƒå‡†å¤‡

#### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 18.04+ / CentOS 7+ / Debian 9+
- **CPU**: 4æ ¸ä»¥ä¸Š (æ¨è8æ ¸+)
- **å†…å­˜**: 8GBä»¥ä¸Š (æ¨è16GB+)
- **ç£ç›˜**: 50GBä»¥ä¸Š SSD
- **ç½‘ç»œ**: åƒå…†ç½‘å¡ (æ¨èä¸‡å…†)

#### ä¾èµ–æœåŠ¡
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y curl wget git vim htop iotop sysstat

# å®‰è£…Go 1.23+
wget https://go.dev/dl/go1.23.0.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# å®‰è£…MySQL 8.0
sudo apt install -y mysql-server-8.0
sudo mysql_secure_installation

# å®‰è£…Redis 7.0+
sudo apt install -y redis-server
```

### åº”ç”¨éƒ¨ç½²

#### æºç éƒ¨ç½²
```bash
# å…‹éš†ä»£ç 
git clone https://github.com/your-org/datamiddleware.git
cd datamiddleware

# ä¸‹è½½ä¾èµ–
go mod download

# æ„å»ºåº”ç”¨
make build

# é…ç½®ç¯å¢ƒ
cp configs/config.yaml configs/config.prod.yaml
vim configs/config.prod.yaml  # ä¿®æ”¹ç”Ÿäº§ç¯å¢ƒé…ç½®

# å¯åŠ¨æœåŠ¡
./datamiddleware -config configs/config.prod.yaml
```

#### é…ç½®ä¼˜åŒ–
```yaml
# ç”Ÿäº§ç¯å¢ƒé…ç½®
server:
  env: prod
  http:
    host: "0.0.0.0"
    port: 8080
    read_timeout: 30s
    write_timeout: 30s
  tcp:
    host: "0.0.0.0"
    port: 9090
    max_connections: 50000  # ç”Ÿäº§ç¯å¢ƒè°ƒå¤§è¿æ¥æ•°

database:
  driver: mysql
  host: "localhost"
  port: 3306
  username: "datamiddleware"
  password: "${DB_PASSWORD}"
  database: "datamiddleware_prod"
  max_open_conns: 200
  max_idle_conns: 50

redis:
  host: "localhost"
  port: 6379
  password: "${REDIS_PASSWORD}"
  pool_size: 50
  min_idle_conns: 10

logging:
  level: info
  format: json
  file:
    path: "/var/log/datamiddleware/app.log"
    max_size: 100
    max_backups: 10
```

### ç³»ç»Ÿä¼˜åŒ–

#### å†…æ ¸å‚æ•°è°ƒä¼˜
```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒå†…æ ¸å‚æ•°ä¼˜åŒ–

cat >> /etc/sysctl.conf << EOF
# ç½‘ç»œä¼˜åŒ–
net.core.somaxconn = 655350
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.ip_local_port_range = 1024 65535
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_keepalive_time = 600

# æ–‡ä»¶æè¿°ç¬¦
fs.file-max = 2097152

# å†…å­˜ä¼˜åŒ–
vm.swappiness = 10
vm.dirty_ratio = 20
vm.dirty_background_ratio = 10
EOF

sysctl -p
```

#### æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
```bash
#!/bin/bash
# è®¾ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶

cat >> /etc/security/limits.conf << EOF
* soft nofile 1048576
* hard nofile 1048576
root soft nofile 1048576
root hard nofile 1048576
EOF

# é‡æ–°ç™»å½•ç”Ÿæ•ˆ
```

#### å¯åŠ¨è„šæœ¬
```bash
#!/bin/bash
# /etc/systemd/system/datamiddleware.service

[Unit]
Description=Data Middleware Service
After=network.target mysql.service redis.service
Requires=mysql.service redis.service

[Service]
Type=simple
User=datamiddleware
Group=datamiddleware
WorkingDirectory=/opt/datamiddleware
ExecStart=/opt/datamiddleware/datamiddleware -config /opt/datamiddleware/configs/config.prod.yaml
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=5
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
```

### ç›‘æ§é…ç½®

#### Prometheusç›‘æ§
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'datamiddleware'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'

  - job_name: 'mysql'
    static_configs:
      - targets: ['localhost:9104']

  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']
```

#### Grafanaä»ªè¡¨æ¿
```json
{
  "dashboard": {
    "title": "Data Middleware Overview",
    "panels": [
      {
        "title": "HTTP Requests",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "Requests/sec"
          }
        ]
      },
      {
        "title": "TCP Connections",
        "type": "graph",
        "targets": [
          {
            "expr": "tcp_active_connections",
            "legendFormat": "Active Connections"
          }
        ]
      }
    ]
  }
}
```

## Dockerå®¹å™¨éƒ¨ç½²

### Dockerfileä¼˜åŒ–
```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM golang:1.23-alpine AS builder

WORKDIR /app

# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache git ca-certificates tzdata

# å¤åˆ¶go modæ–‡ä»¶
COPY go.mod go.sum ./
RUN go mod download

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN CGO_ENABLED=0 GOOS=linux go build \
    -a -installsuffix cgo \
    -o datamiddleware \
    -ldflags '-w -s -X main.version=$(git describe --tags --always)' \
    ./cmd/server

# è¿è¡Œé˜¶æ®µ
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata
WORKDIR /root/

# åˆ›å»ºérootç”¨æˆ·
RUN adduser -D -s /bin/sh appuser
USER appuser

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/datamiddleware .

# æš´éœ²ç«¯å£
EXPOSE 8080 9090

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["./datamiddleware"]
```

### Docker Composeç¼–æ’
```yaml
version: '3.8'

services:
  datamiddleware:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      - DB_HOST=mysql
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./configs:/app/configs:ro
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: datamiddleware
      MYSQL_USER: datamiddleware
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      timeout: 20s
      retries: 10

  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
    restart: unless-stopped

volumes:
  mysql_data:
  redis_data:
  prometheus_data:
  grafana_data:
```

### å®¹å™¨ä¼˜åŒ–é…ç½®
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  datamiddleware:
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  mysql:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  redis:
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G
```

## Kubernetesé›†ç¾¤éƒ¨ç½²

### éƒ¨ç½²æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes Cluster                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ingress    â”‚  Service    â”‚ Deployment  â”‚ ConfigMap   â”‚   â”‚
â”‚  â”‚ Controller  â”‚  (Load      â”‚  (App       â”‚  (Config)   â”‚   â”‚
â”‚  â”‚             â”‚   Balance)  â”‚   Pods)     â”‚             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ StatefulSet â”‚ Persistent  â”‚ Service     â”‚ ConfigMap   â”‚   â”‚
â”‚  â”‚  (MySQL)    â”‚  Volume     â”‚  (MySQL)    â”‚  (MySQL)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Deployment  â”‚ Persistent  â”‚ Service     â”‚ ConfigMap   â”‚   â”‚
â”‚  â”‚  (Redis)    â”‚  Volume     â”‚  (Redis)    â”‚  (Redis)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åº”ç”¨éƒ¨ç½²é…ç½®

#### Namespace
```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: datamiddleware
  labels:
    name: datamiddleware
```

#### ConfigMap
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: datamiddleware-config
  namespace: datamiddleware
data:
  config.yaml: |
    server:
      env: prod
      http:
        host: "0.0.0.0"
        port: 8080
      tcp:
        host: "0.0.0.0"
        port: 9090
        max_connections: 50000

    database:
      driver: mysql
      host: mysql-service
      port: 3306
      username: datamiddleware
      passwordFromSecret: true
      database: datamiddleware_prod
      max_open_conns: 200
      max_idle_conns: 50

    redis:
      host: redis-service
      port: 6379
      passwordFromSecret: true
      pool_size: 50
      min_idle_conns: 10
```

#### Secret
```yaml
# k8s/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: datamiddleware-secrets
  namespace: datamiddleware
type: Opaque
data:
  db-password: <base64-encoded-password>
  redis-password: <base64-encoded-password>
  jwt-secret: <base64-encoded-jwt-secret>
```

#### Deployment
```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: datamiddleware
  namespace: datamiddleware
  labels:
    app: datamiddleware
spec:
  replicas: 3
  selector:
    matchLabels:
      app: datamiddleware
  template:
    metadata:
      labels:
        app: datamiddleware
    spec:
      containers:
      - name: datamiddleware
        image: your-registry/datamiddleware:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 9090
          name: tcp
        env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: datamiddleware-secrets
              key: db-password
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: datamiddleware-secrets
              key: redis-password
        volumeMounts:
        - name: config
          mountPath: /app/configs
          readOnly: true
        - name: logs
          mountPath: /app/logs
        resources:
          limits:
            cpu: "2"
            memory: "4Gi"
          requests:
            cpu: "1"
            memory: "2Gi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: datamiddleware-config
      - name: logs
        emptyDir: {}
```

#### Service
```yaml
# k8s/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: datamiddleware-service
  namespace: datamiddleware
spec:
  selector:
    app: datamiddleware
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: tcp
    port: 9090
    targetPort: 9090
    protocol: TCP
  type: ClusterIP
```

#### Ingress
```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: datamiddleware-ingress
  namespace: datamiddleware
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - api.yourdomain.com
    secretName: datamiddleware-tls
  rules:
  - host: api.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: datamiddleware-service
            port:
              number: 80
```

### MySQLé›†ç¾¤éƒ¨ç½²

#### StatefulSet
```yaml
# k8s/mysql-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
  namespace: datamiddleware
spec:
  serviceName: mysql
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: datamiddleware-secrets
              key: db-root-password
        - name: MYSQL_DATABASE
          value: "datamiddleware_prod"
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-data
          mountPath: /var/lib/mysql
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
        resources:
          limits:
            cpu: "1"
            memory: "2Gi"
          requests:
            cpu: "500m"
            memory: "1Gi"
  volumeClaimTemplates:
  - metadata:
      name: mysql-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
```

### Redisé›†ç¾¤éƒ¨ç½²

#### Redis Cluster
```yaml
# k8s/redis-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: datamiddleware
spec:
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --requirepass
        - $(REDIS_PASSWORD)
        - --maxmemory
        - 512mb
        - --maxmemory-policy
        - allkeys-lru
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: datamiddleware-secrets
              key: redis-password
        ports:
        - containerPort: 6379
          name: redis
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          limits:
            cpu: "500m"
            memory: "1Gi"
          requests:
            cpu: "200m"
            memory: "512Mi"
      volumes:
      - name: redis-data
        emptyDir: {}
```

### ç›‘æ§å’Œæ—¥å¿—

#### Prometheuséƒ¨ç½²
```yaml
# k8s/prometheus-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config
          mountPath: /etc/prometheus
        - name: data
          mountPath: /prometheus
      volumes:
      - name: config
        configMap:
          name: prometheus-config
      - name: data
        persistentVolumeClaim:
          claimName: prometheus-pvc
```

#### EFKæ—¥å¿—æ ˆ
```yaml
# k8s/elasticsearch-deployment.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: logging
spec:
  serviceName: elasticsearch
  replicas: 3
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.5.0
        env:
        - name: discovery.type
          value: single-node
        - name: ES_JAVA_OPTS
          value: "-Xms1g -Xmx1g"
        ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
        volumeMounts:
        - name: data
          mountPath: /usr/share/elasticsearch/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 50Gi
```

### éƒ¨ç½²è„šæœ¬

#### ä¸€é”®éƒ¨ç½²è„šæœ¬
```bash
#!/bin/bash
# deploy.sh

set -e

NAMESPACE="datamiddleware"
RELEASE_NAME="datamiddleware-v1.0.0"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² Data Middleware..."

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# éƒ¨ç½²é…ç½®
echo "ğŸ“ éƒ¨ç½²é…ç½®..."
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml

# éƒ¨ç½²å­˜å‚¨
echo "ğŸ’¾ éƒ¨ç½²å­˜å‚¨..."
kubectl apply -f k8s/persistent-volume.yaml
kubectl apply -f k8s/persistent-volume-claim.yaml

# éƒ¨ç½²æ•°æ®åº“
echo "ğŸ—„ï¸ éƒ¨ç½²æ•°æ®åº“..."
kubectl apply -f k8s/mysql-service.yaml
kubectl apply -f k8s/mysql-statefulset.yaml

# ç­‰å¾…MySQLå°±ç»ª
echo "â³ ç­‰å¾…MySQLå°±ç»ª..."
kubectl wait --for=condition=ready pod -l app=mysql -n $NAMESPACE --timeout=300s

# éƒ¨ç½²Redis
echo "ğŸ”„ éƒ¨ç½²Redis..."
kubectl apply -f k8s/redis-service.yaml
kubectl apply -f k8s/redis-deployment.yaml

# ç­‰å¾…Rediså°±ç»ª
echo "â³ ç­‰å¾…Rediså°±ç»ª..."
kubectl wait --for=condition=ready pod -l app=redis -n $NAMESPACE --timeout=300s

# éƒ¨ç½²åº”ç”¨
echo "ğŸ—ï¸ éƒ¨ç½²åº”ç”¨..."
kubectl apply -f k8s/service.yaml
kubectl apply -f k8s/deployment.yaml

# ç­‰å¾…åº”ç”¨å°±ç»ª
echo "â³ ç­‰å¾…åº”ç”¨å°±ç»ª..."
kubectl wait --for=condition=ready pod -l app=datamiddleware -n $NAMESPACE --timeout=300s

# éƒ¨ç½²Ingress
echo "ğŸŒ éƒ¨ç½²Ingress..."
kubectl apply -f k8s/ingress.yaml

# éƒ¨ç½²ç›‘æ§
echo "ğŸ“Š éƒ¨ç½²ç›‘æ§..."
kubectl apply -f k8s/prometheus-deployment.yaml
kubectl apply -f k8s/grafana-deployment.yaml

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo ""
echo "ğŸ“‹ æœåŠ¡ä¿¡æ¯:"
echo "HTTP API: http://api.yourdomain.com"
echo "TCPæœåŠ¡: tcp://api.yourdomain.com:9090"
echo "ç›‘æ§é¢æ¿: http://grafana.yourdomain.com"
echo "Prometheus: http://prometheus.yourdomain.com"
echo ""
echo "ğŸ” æŸ¥çœ‹çŠ¶æ€:"
echo "kubectl get all -n $NAMESPACE"
```

#### å›æ»šè„šæœ¬
```bash
#!/bin/bash
# rollback.sh

set -e

NAMESPACE="datamiddleware"
DEPLOYMENT="datamiddleware"

echo "ğŸ”„ å¼€å§‹å›æ»š..."

# æŸ¥çœ‹éƒ¨ç½²å†å²
echo "ğŸ“œ éƒ¨ç½²å†å²:"
kubectl rollout history deployment/$DEPLOYMENT -n $NAMESPACE

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
echo "âª å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE

# ç­‰å¾…å›æ»šå®Œæˆ
echo "â³ ç­‰å¾…å›æ»šå®Œæˆ..."
kubectl wait --for=condition=ready pod -l app=datamiddleware -n $NAMESPACE --timeout=300s

echo "âœ… å›æ»šå®Œæˆï¼"
```

## æ€§èƒ½ä¼˜åŒ–

### å®¹å™¨ä¼˜åŒ–

#### èµ„æºé™åˆ¶
```yaml
# k8s/resource-limits.yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: datamiddleware-limits
  namespace: datamiddleware
spec:
  limits:
  - type: Container
    default:
      cpu: "2"
      memory: "4Gi"
    defaultRequest:
      cpu: "1"
      memory: "2Gi"
    max:
      cpu: "4"
      memory: "8Gi"
    min:
      cpu: "100m"
      memory: "128Mi"
```

#### HPAè‡ªåŠ¨æ‰©ç¼©å®¹
```yaml
# k8s/hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: datamiddleware-hpa
  namespace: datamiddleware
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: datamiddleware
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  - type: Pods
    pods:
      metric:
        name: http_requests_per_second
      target:
        type: AverageValue
        averageValue: 1000
```

### ç½‘ç»œä¼˜åŒ–

#### Service Mesh
```yaml
# k8s/istio-gateway.yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: datamiddleware-gateway
  namespace: datamiddleware
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - api.yourdomain.com
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: datamiddleware-tls
    hosts:
    - api.yourdomain.com
```

### å­˜å‚¨ä¼˜åŒ–

#### PVCä¼˜åŒ–
```yaml
# k8s/pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: datamiddleware
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd
  resources:
    requests:
      storage: 500Gi
```

## è¿ç»´ç®¡ç†

### æ—¥å¿—ç®¡ç†

#### é›†ä¸­æ—¥å¿—æ”¶é›†
```yaml
# k8s/fluent-bit-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off

    [INPUT]
        Name              tail
        Path              /var/log/containers/*datamiddleware*.log
        Parser            docker
        Tag               datamiddleware.*
        Refresh_Interval  5

    [OUTPUT]
        Name  es
        Match datamiddleware.*
        Host  elasticsearch
        Port  9200
        Index datamiddleware
```

### å¤‡ä»½æ¢å¤

#### æ•°æ®åº“å¤‡ä»½
```yaml
# k8s/mysql-backup-cronjob.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: mysql-backup
  namespace: datamiddleware
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: mysql-backup
            image: mysql:8.0
            command:
            - /bin/bash
            - -c
            - |
              mysqldump -h mysql-service -u root -p$MYSQL_ROOT_PASSWORD datamiddleware_prod > /backup/backup-$(date +%Y%m%d-%H%M%S).sql
            env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: datamiddleware-secrets
                  key: db-root-password
            volumeMounts:
            - name: backup
              mountPath: /backup
          volumes:
          - name: backup
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### å®‰å…¨åŠ å›º

#### Podå®‰å…¨ç­–ç•¥
```yaml
# k8s/pod-security-policy.yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: restricted-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  supplementalGroups:
    rule: 'MustRunAs'
    ranges:
    - min: 1
      max: 65535
  fsGroup:
    rule: 'MustRunAs'
    ranges:
    - min: 1
      max: 65535
```

#### ç½‘ç»œç­–ç•¥
```yaml
# k8s/network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: datamiddleware-network-policy
  namespace: datamiddleware
spec:
  podSelector:
    matchLabels:
      app: datamiddleware
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: nginx  # åªå…è®¸Nginxè®¿é—®
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
  - to:
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379
```

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜è¯Šæ–­

#### åº”ç”¨å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -n datamiddleware

# æŸ¥çœ‹Podæ—¥å¿—
kubectl logs -f pod/datamiddleware-xxxxx -n datamiddleware

# æŸ¥çœ‹Podäº‹ä»¶
kubectl describe pod/datamiddleware-xxxxx -n datamiddleware
```

#### æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥MySQLæœåŠ¡
kubectl get svc mysql -n datamiddleware

# æµ‹è¯•æ•°æ®åº“è¿æ¥
kubectl exec -it pod/mysql-xxxxx -n datamiddleware -- mysql -u datamiddleware -p datamiddleware_prod

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
kubectl logs -f pod/mysql-xxxxx -n datamiddleware
```

#### ç½‘ç»œè¿é€šæ€§é—®é¢˜
```bash
# æµ‹è¯•æœåŠ¡è¿é€šæ€§
kubectl run test --image=busybox --rm -it --restart=Never -- wget http://datamiddleware-service/health

# æŸ¥çœ‹ç½‘ç»œç­–ç•¥
kubectl get networkpolicies -n datamiddleware

# æ£€æŸ¥DNSè§£æ
kubectl exec -it pod/datamiddleware-xxxxx -n datamiddleware -- nslookup mysql-service
```

### æ€§èƒ½é—®é¢˜æ’æŸ¥

#### CPUä½¿ç”¨ç‡è¿‡é«˜
```bash
# æŸ¥çœ‹Podèµ„æºä½¿ç”¨
kubectl top pods -n datamiddleware

# ç”Ÿæˆæ€§èƒ½åˆ†æ
kubectl exec -it pod/datamiddleware-xxxxx -n datamiddleware -- go tool pprof http://localhost:6060/debug/pprof/profile

# æŸ¥çœ‹çº¿ç¨‹æ•°
kubectl exec -it pod/datamiddleware-xxxxx -n datamiddleware -- ps -T -p 1
```

#### å†…å­˜ä½¿ç”¨å¼‚å¸¸
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
kubectl top pods -n datamiddleware --sort-by=memory

# ç”Ÿæˆå †åˆ†æ
kubectl exec -it pod/datamiddleware-xxxxx -n datamiddleware -- go tool pprof http://localhost:6060/debug/pprof/heap

# æŸ¥çœ‹GCç»Ÿè®¡
kubectl logs pod/datamiddleware-xxxxx -n datamiddleware | grep "gc"
```

## æ€»ç»“

æ•°æ®ä¸­é—´ä»¶æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼š

1. **å•æœºéƒ¨ç½²**: é€‚åˆå¼€å‘æµ‹è¯•å’Œå°å‹ç”Ÿäº§ç¯å¢ƒ
2. **Dockeréƒ¨ç½²**: å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¾¿äºç¯å¢ƒä¸€è‡´æ€§
3. **Kuberneteséƒ¨ç½²**: äº‘åŸç”Ÿéƒ¨ç½²ï¼Œæ”¯æŒå¼¹æ€§ä¼¸ç¼©å’Œé«˜å¯ç”¨

æ¯ç§éƒ¨ç½²æ–¹å¼éƒ½æœ‰ç›¸åº”çš„ä¼˜åŒ–ç­–ç•¥å’Œç›‘æ§æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿåœ¨ä¸åŒè§„æ¨¡ä¸‹çš„ç¨³å®šè¿è¡Œå’Œé«˜æ•ˆæ€§èƒ½ã€‚

å…³é”®éƒ¨ç½²ç‰¹æ€§ï¼š
- **é«˜å¯ç”¨**: å¤šå‰¯æœ¬éƒ¨ç½²ã€è‡ªåŠ¨æ•…éšœè½¬ç§»
- **å¯æ‰©å±•**: æ°´å¹³æ‰©ç¼©å®¹ã€èµ„æºåŠ¨æ€è°ƒæ•´
- **å¯è§‚æµ‹**: å…¨é¢ç›‘æ§ã€æ—¥å¿—æ”¶é›†ã€æ€§èƒ½åˆ†æ
- **å®‰å…¨åˆè§„**: ç½‘ç»œéš”ç¦»ã€è®¿é—®æ§åˆ¶ã€å®‰å…¨åŠ å›º
